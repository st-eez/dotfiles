#!/usr/bin/env bash
# tmux-git-info - Display git branch info for tmux status bar
# Usage: tmux-git-info [--with-path]
#
# Options:
#   --with-path    Include abbreviated current directory before branch name
#
# Output:
#   - If in a git repo: branch name (e.g., "main" or "feature/foo")
#   - If not in a git repo: empty string
#   - With --with-path: "~/Projects/foo main" or just "~/Projects/foo" if not in repo

# Fast exit if git is not available
command -v git &>/dev/null || exit 0

show_path=false
if [[ "${1:-}" == "--with-path" ]]; then
    show_path=true
fi

# Get abbreviated path (replace $HOME with ~)
get_abbrev_path() {
    echo "${PWD/$HOME/\~}"
}

# Get git branch name efficiently
# Uses git symbolic-ref first (fast), falls back to rev-parse for detached HEAD
get_git_branch() {
    # Check if we're in a git repo (fastest check)
    git rev-parse --is-inside-work-tree &>/dev/null || return 1

    # Try symbolic-ref first (works for normal branches)
    local branch
    branch=$(git symbolic-ref --short HEAD 2>/dev/null)

    if [[ -n "$branch" ]]; then
        echo "$branch"
        return 0
    fi

    # Fallback for detached HEAD - show short commit hash
    local commit
    commit=$(git rev-parse --short HEAD 2>/dev/null)
    if [[ -n "$commit" ]]; then
        echo "($commit)"
        return 0
    fi

    return 1
}

# Main output
if $show_path; then
    path=$(get_abbrev_path)
    branch=$(get_git_branch)
    if [[ -n "$branch" ]]; then
        echo "$path $branch"
    else
        echo "$path"
    fi
else
    get_git_branch
fi
