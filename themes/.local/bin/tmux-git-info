#!/usr/bin/env bash
# tmux-git-info - Display git branch + abbreviated directory for tmux status bar
# Usage: tmux-git-info [path]
#
# Output: "~/P/P/dirname  branch" - path abbreviated with first letter of each parent
# Padded to fixed width to prevent status bar shifting

command -v git &>/dev/null || exit 0

target_dir="${1:-$PWD}"
cd "$target_dir" 2>/dev/null || exit 0

# Abbreviated path: ~/P/P/dirname (first letter of parents, full name for current)
abbrev_path() {
  local path="${PWD/#$HOME/\~}"
  local parts=()
  local IFS='/'
  read -ra parts <<<"$path"

  local result=""
  local last_idx=$((${#parts[@]} - 1))

  for i in "${!parts[@]}"; do
    local part="${parts[$i]}"
    if [[ -z "$part" ]]; then
      continue
    elif [[ "$part" == "~" ]]; then
      result="~"
    elif [[ $i -eq $last_idx ]]; then
      # Last part: show full name
      result="$result/$part"
    else
      # Parent: show first letter only
      result="$result/${part:0:1}"
    fi
  done

  echo "$result"
}

abbrev=$(abbrev_path)

# Git branch
branch=""
if git rev-parse --is-inside-work-tree &>/dev/null; then
  branch=$(git symbolic-ref --short HEAD 2>/dev/null)
  [[ -z "$branch" ]] && branch=$(git rev-parse --short HEAD 2>/dev/null)
fi

if [[ -n "$branch" ]]; then
  output="$abbrev îœ¥ $branch"
else
  output="$abbrev"
fi

# Pad to fixed width (30 chars) to prevent status bar shifting
printf "%30s" "$output"
